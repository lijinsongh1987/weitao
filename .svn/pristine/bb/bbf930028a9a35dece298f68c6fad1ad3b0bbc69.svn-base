<?php

class NewsAction extends Action{
    public function news(){
        $this -> news = M('caiji')->where("status = 1")->limit(20)->select();
        $this->display();       
    }
   
    
    public function newscontent(){
        $id = $_GET['id'];
        $news = M('caiji')->where("id = $id")->order("shixiaotime desc")->select();
        //ÊÕ¼¯ÔÄ¶ÁÊı
        if ($_GET['openid']) {
        	$list = M("read")->where("rid = ".$_GET['id']." and openid = ".$_GET['openid'])->select();
        	//ÅĞ¶ÏÊÇÌí¼Ó»¹ÊÇĞŞ¸Ä
        	if ($list) {
        		//ĞŞ¸Ä
        		if ($list[0]['readnumber'] < 20) {
        			$data['readnumber'] = $data['readnumber'] + 1;
        			$data['readtime'] = date("Y-m-d H:i:s");
        			M("read")->where("rid = ".$_GET['id']." and openid = ".$_GET['openid'])->save($data);
        		}
        	} else {
        		//Ìí¼Ó
        		$data['rid'] = $_GET['id'];
        		$data['openid'] = $_GET['openid'];
        		$data['readnumber'] = 1;
        		$data['readtime'] = date("Y-m-d H:i:s");
        		M("read")->add($data);
        	}
        }
        $this->newslist = $news[0]['content'];
        $this->display();
    }
    
    public function datajson(){
        $conter = $_GET['counter'];
        $conter = $conter*20;
        $data = M('caiji')->where("status = 1")->limit($conter,20)->order("shixiaotime desc")->select();
        //$data['sql'] = M()->getLastSql();
        echo json_encode($data);
    }
    
    public function changeurl(){
    	$quanlink = $_GET['quanlink'];
    	$id = $_GET['id'];
    	$goodsid = $_GET['goodsid'];
    	$data = $this->getgourllink($quanlink,$id,$goodsid);
    	echo json_encode($data);
    }
    
    public function getgourllink ($quanlink,$id,$goodsid) {
    	$urllist = M("url")->field("status")->find();
    	$data['jumpstatus'] = $urllist['status'];
    	if ($data['jumpstatus'] == 0) {
    		//×ªï¿½ï¿½ï¿½ï¿½ï¿½ï¿½534150603181
    		$pid = "mm_30979406_3042389_10494070";
    		$pidlist = split("_",$pid);
    		//ï¿½ï¿½Ñ¯ï¿½ï¿½Ó¦ï¿½ï¿½tokenid
    		$tokenid = M("account")->where("member_id = '".$pidlist[1]."'")->find();
    		$url = "http://tbapi.00o.cn/highapi.php";
    		$linklist = array();
    		$linklist =  split("&",$quanlink);
    		$linklist[1] = str_replace("activity_id", "activityId", $linklist[1]);
    		$post_data = array ("item_id" => $goodsid,"adzone_id" => "10494070","platform"=>"1","site_id"=>"3042389","token"=>$tokenid['access_token']);
    		$ch = curl_init();
    		curl_setopt($ch, CURLOPT_URL, $url);
    		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    		// postï¿½ï¿½ï¿½ï¿½
    		curl_setopt($ch, CURLOPT_POST, 1);
    		// postï¿½Ä±ï¿½ï¿½ï¿½
    		curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);
    		$output = array();
    		$output = curl_exec($ch);
    		curl_close($ch);
    		$output_array = json_decode($output,true);
    		$data['gourllink'] = $output_array['result']['data']['coupon_click_url']."&".$linklist[1];
    	}
    	return $data;
    }
}

?>