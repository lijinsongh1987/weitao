<?php
/**
 * 微信网页授权（微信端Action必须继承）
 */

include "wechat/wechat.class.php";
include "wechat/WxMchPayHelper.php";

class AuthAction extends Action{
    
	public $open_id;
	public $wxuser;
	
	public function _initialize () {
		$this->weichatOauth();
		session_start();
	}
	
	public function weichatOauth(){
		
		//微信配置信息
		$options = array(
			'token'=>C('token'),
			'encodingaeskey'=>C('encodingaeskey'),
			'appid'=>C('appid'),
			'appsecret'=>C('appsecret')
		);
		
		$scope = 'snsapi_base';
		$code = isset($_GET['code'])?$_GET['code']:'';
		$token_time = isset($_SESSION['token_time'])?$_SESSION['token_time']:0;
		//已经授权
		if(!$code && isset($_SESSION['open_id']) && isset($_SESSION['user_token']) && $token_time>time()-3600){
			if (!$this->wxuser) {
				$this->wxuser = $_SESSION['wxuser'];
			}
			$this->open_id = $_SESSION['open_id'];
			return $this->open_id;
			
		}else {
			
			$we_obj = new Wechat($options);
			if ($code) {//如果code存在，则获取access_token
				$json = $we_obj->getOauthAccessToken();
				if (!$json) {
					unset($_SESSION['wx_redirect']);
					die('获取用户授权失败，请重新确认');
				}
				$_SESSION['open_id'] = $this->open_id = $json["openid"];
				$access_token = $json['access_token'];
				$_SESSION['user_token'] = $access_token;
				$_SESSION['token_time'] = time();
				$userinfo = $we_obj->getUserInfo($this->open_id);
				if ($userinfo && !empty($userinfo['nickname'])) {
					$this->wxuser = array(
							'open_id'=>$this->open_id,
							'nickname'=>$userinfo['nickname'],
							'sex'=>intval($userinfo['sex']),
							'location'=>$userinfo['province'].'-'.$userinfo['city'],
							'avatar'=>$userinfo['headimgurl']
					);
				} elseif (strstr($json['scope'],'snsapi_userinfo')!==false) {
					$userinfo = $we_obj->getOauthUserinfo($access_token,$this->open_id);
					if ($userinfo && !empty($userinfo['nickname'])) {
						$this->wxuser = array(
								'open_id'=>$this->open_id,
								'nickname'=>$userinfo['nickname'],
								'sex'=>intval($userinfo['sex']),
								'location'=>$userinfo['province'].'-'.$userinfo['city'],
								'avatar'=>$userinfo['headimgurl']
						);
					} else {
						return $this->open_id;
					}
				}
				if ($this->wxuser) {
					$_SESSION['wxuser'] = $this->wxuser;
					$_SESSION['open_id'] =  $json["openid"];
					unset($_SESSION['wx_redirect']);
					return $this->open_id;
				}
				
				//如果没有获取到userInfo信息 ，换个snsapi_userinfo授权请求
				$scope = 'snsapi_userinfo';
			}
			
			if ($scope=='snsapi_base') {
				$url = $this->get_url();
				$_SESSION['wx_redirect'] = $url;
			} else {
				$url = $_SESSION['wx_redirect'];
			}
			if (!$url) {
				unset($_SESSION['wx_redirect']);
				die('获取用户授权失败');
			}
			$oauth_url = $we_obj->getOauthRedirect($url,"wxbase",$scope);
			header('Location: ' . $oauth_url);
		}
	}
	
	/**
	 * 
	 * @param  $posterPath 海报的地址
	 * @param  $fanId  粉丝的ID
	 * @return 
	 */
	public function getPosterQRCode($posterPath,$fanId){
	
		$filePath = './poster/qr/';
		/*
		if (!file_exists($filePath)) {
			mkdir ($filePath);
		}
		*/
		//微信配置信息
		$options = array(
			'token'=>C('token'),
			'encodingaeskey'=>C('encodingaeskey'),
			'appid'=>C('appid'),
			'appsecret'=>C('appsecret')
		);
		
		$we_obj = new Wechat($options);
		$tickArr = $we_obj->getQRCode($fanId, 1, 2592000);
		//获取到二维码的http地址
		$qrUrl = 'http://mp.weixin.qq.com/cgi-bin/showqrcode?ticket='.urlencode($tickArr['ticket']);
		$qrName = $fanId.'_'.$this->msectime();
		$qrPath = $filePath.$qrName.'.jpg';
		$this->curlDownload($qrUrl, $qrPath);
		
		//等比例压缩图片
		list($width, $height) = getimagesize($qrPath);
		$new = imagecreatetruecolor(86,86);
		$img = imagecreatefromjpeg($qrPath);
		imagecopyresized($new, $img,0, 0,0, 0,86,86, $width, $height);//copy部分图像并调整
		imagejpeg($new, $qrPath);//图像输出新图片、另存为
		imagedestroy($new);
		imagedestroy($img);
		
		//合并图片
		return $this->merge($posterPath, $qrPath,$qrName);
	}
	
	/**
	 * 合并图片
	 * @param  $bigImgPath
	 * @param  $qCodePath
	 * @return string
	 */
	private function merge($bigImgPath,$qCodePath,$qrName){
		
		
		
		$bigImg = imagecreatefromstring(file_get_contents($bigImgPath));
		$qCodeImg = imagecreatefromstring(file_get_contents($qCodePath));
		
		//文字
		/*
		$font = './msyhl.ttc';//字体
		$black = imagecolorallocate($bigImg, 45, 152, 62);//字体颜色 RGB
		$fontSize = 20;   //字体大小
		$circleSize = 0; //旋转角度
		$left = 50;      //左边距
		$top = 150;       //顶边距
		imagefttext($bigImg, $fontSize, $circleSize, $left, $top, $black, $font, '我饿哦饿哦饿哦放到我我我我我防守打法');
		*/
		list($qCodeWidth, $qCodeHight, $qCodeType) = getimagesize($qCodePath);
		
		
		imagecopymerge($bigImg, $qCodeImg, 182,588, 0, 0, 86,86, 100);//234, 234  495,830
		list($bigWidth, $bigHight, $bigType) = getimagesize($bigImgPath);
				
		$qrPath = './poster/'.$qrName;
		$path = '/poster/'.$qrName;
		switch ($bigType) {
			case 1:
				imagegif($bigImg, $qrPath.".gif");
				$path= $path.".gif";
				break;
			case 2:
				imagejpeg($bigImg, $qrPath.".jpg");
				$path= $path.".jpg";
				break;
			case 3:
				imagepng($bigImg, $qrPath.".png");
				$path= $path.".png";
				break;
			default:
				break;
		}
		
		imagedestroy($bigImg);
		imagedestroy($qcodeImg);
		return $path;

	}
	
	
	
	/**
	 * 获取当前页面完整URL地址
	 */
	private function get_url() {
		$sys_protocal = isset($_SERVER['SERVER_PORT']) && $_SERVER['SERVER_PORT'] == '443' ? 'https://' : 'http://';
		$php_self = $_SERVER['PHP_SELF'] ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];
		$path_info = isset($_SERVER['PATH_INFO']) ? $_SERVER['PATH_INFO'] : '';
		$relate_url = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : $php_self.(isset($_SERVER['QUERY_STRING']) ? '?'.$_SERVER['QUERY_STRING'] : $path_info);
		return $sys_protocal.(isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : '').$relate_url;
	}
	
	/**
	 * 获取Unix毫秒时间戳
	 * @return float Unix毫秒时间戳
	 */
	function msectime(){
		list($msec, $sec) = explode(' ', microtime());
		return (float)sprintf('%.0f', (floatval($msec) + floatval($sec)) * 1000);
	}  
	
	
	
	
	/**
	 * 下载图片（二维码）
	 * @param unknown $remote
	 * @param unknown $local
	 */
	private function curlDownload($remote,$local) {
		$cp = curl_init($remote);
		$fp = fopen($local,"w");
		curl_setopt($cp, CURLOPT_FILE, $fp);
		curl_setopt($cp, CURLOPT_HEADER, 0);
		curl_exec($cp);
		curl_close($cp);
		fclose($fp);
	}
	
	
	public function pay($openId,$money,$note){
		// 企业转账给个人
		$param = [
				"nonce_str" => $this->randCode(30),//随机字符串，不长于32位
				"mchid" => C("mchid"),//商户号
				"mch_appid" =>  C("appid"),
				"partner_trade_no" => $this->orderNum(),//商户订单号，需保持唯一性(只能是字母或者数字，不能包含有符号)
				"openid" => $openId,
				"amount" => $money,//付款金额，单位分
				"check_name" => 'NO_CHECK',	//校验用户姓名选项  NO_CHECK：不校验真实姓名FORCE_CHECK：强校验真实姓名
				"re_user_name" => '',	//收款用户姓名(可选) 如果check_name设置为FORCE_CHECK，则必填用户真实姓名
				"spbill_create_ip" => '127.0.0.1',//调用接口的机器 Ip 地址
				"desc" => $note,//备注信息
		];
		$wxMchPayHelper = new WxMchPayHelper($param);
		return $wxMchPayHelper->transfers();
	}
	
	
	/**
	 +----------------------------------------------------------
	 * 生成随机字符串
	 +----------------------------------------------------------
	 * @param int       $length  要生成的随机字符串长度
	 * @param string    $type    随机码类型：0，数字+大小写字母；1，数字；2，小写字母；3，大写字母；4，特殊字符；-1，数字+大小写字母+特殊字符
	 +----------------------------------------------------------
	 * @return string
	 +----------------------------------------------------------
	 */
	function randCode($length = 5, $type = 0) {
		$arr = array(1 => "0123456789", 2 => "abcdefghijklmnopqrstuvwxyz", 3 => "ABCDEFGHIJKLMNOPQRSTUVWXYZ", 4 => "~@#$%^&*(){}[]|");
		if ($type == 0) {
			array_pop($arr);
			$string = implode("", $arr);
		} elseif ($type == "-1") {
			$string = implode("", $arr);
		} else {
			$string = $arr[$type];
		}
		$count = strlen($string) - 1;
		$code = '';
		for ($i = 0; $i < $length; $i++) {
			$code .= $string[rand(0, $count)];
		}
		return $code;
	}
	
	/**
	 * 生成订单号
	 */
	public function orderNum(){
		list($s1, $s2) = explode(' ', microtime());
		return (float)sprintf('%.0f', (floatval($s1) + floatval($s2)) * 1000).$this->randCode(10,1);
	}
	
	/**
	 * 订单消息模板
	 * @param unknown $openId
	 * @param unknown $title
	 * @param unknown $messageType
	 * @param unknown $date
	 * @param unknown $remark
	 */
	public function sendMsgTemp($openId,$url,$title,$messageType,$date,$remark){
				
		$touser = array();
		$touser['touser'] = $openId;
		$touser['template_id'] = "8fss7iPkvEjtm8tosxd6hlGXTq3LwzWam4FwQzP4LY4";
		$touser['url'] = $url;
		$touser['topcolor'] = "#111111";
		
		$data = array();
		
		$dataValue['value'] = $title;
		$dataValue['color'] = "#111111";
		$data['first'] = $dataValue;
		
		$dataValue['value'] = $messageType;
		$dataValue['color'] = "#111111";
		$data['keyword1'] = $dataValue;
		
		$dataValue['value'] = $date;
		$dataValue['color'] = "#111111";
		$data['keyword2'] = $dataValue;
		
		
		$dataValue['value'] = $remark;
		$dataValue['color'] = "#111111";
		$data['remark'] = $dataValue;
		
		$touser['data'] = $data;
		
		$options = array(
				'token'=>C('token'),
				'encodingaeskey'=>C('encodingaeskey'),
				'appid'=>C('appid'),
				'appsecret'=>C('appsecret')
		);
		
		$we_obj = new Wechat($options);
		
		$json = $we_obj->sendTemplateMessage($touser);
	}
	
}