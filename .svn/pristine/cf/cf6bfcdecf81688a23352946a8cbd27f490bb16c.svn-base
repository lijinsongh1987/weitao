<?php 
class OtherSetupAction extends BaseAction{
    //知识课堂
    public function classroom(){
        $this->type = M("texttype")->select();
        
        if ($_GET['texttitle']) {
            $and .=" and a.title = '".$_GET['texttitle']."'";
        }
        if ($_GET['texttypesubmit']) {
            $and .=" and a.type = '".$_GET['texttypesubmit']."'";
        }
        import("ORG.Util.Page");
        $totalRows=M()->table("wt_classroom a,wt_texttype b,wt_user c")->where("a.type = b.id and a.userid = c.id ".$and)->count();
        $page= new Page($totalRows,20);
        $this->list = M()->table("wt_classroom a,wt_texttype b,wt_user c")->where("a.type = b.id and a.userid = c.id")->limit($page->firstRow,$page->listRows)->field("a.*,b.typename,c.realname")->order("time desc")->select();
//         echo M()->getLastSql();
        $this->page= $page->show();
        $this->display();
    }
    public function addtext(){
    	import('ORG.Net.UploadFile');
    	$upload = new UploadFile();
    	$upload->maxSize  = 3145728 ;
    	$upload->allowExts  = array('jpg', 'png', 'jpeg');
    	$upload->savePath =  './textimg/';
    	$upload->upload();
    	$info = $upload->getUploadFileInfo();
    	if ($info[0]['savename']) {
    		$data['imgurl'] = './textimg/'.$info[0]['savename'];
    	}
        if ($_POST['id']) {
            $data['id'] = $_POST['id'];
            $data['title'] = $_POST['title'];
            $data['type'] = $_POST['type'];
            $data['conten'] = $_POST['editor'];
            $is = M("classroom")->save($data);
        } else {
            $data['title'] = $_POST['title'];
            $data['type'] = $_POST['type'];
            $data['userid'] = $_SESSION['user'][0]['id'];
            $data['time'] = date("Y-m-d H:i:s");
            $data['conten'] = $_POST['editor'];
            $is = M("classroom")->add($data);
        }
        $this->redirect("OtherSetup/classroom");
    }
    public function getclassroom(){
        $id = $_GET['id'];
        $list = M("classroom")->where("id = ".$id)->select();
        echo json_encode($list);
    }
    
    public function delclassroom(){
        $is = M("classroom")->where("id = ".$_GET['id'])->delete();
        if ($is) {
            $data['msg'] = 1;
        } else {
            $data['msg'] = 0;
        }
        echo json_encode($data);
    }
    
    //文章添加
    public function addconten(){
        if ($_GET['id']) {
            $this->classlist = M('classroom')->find($_GET['id']);
        }
        $this->type = M("texttype")->select();
        $this->display();
    }
    
}
?>