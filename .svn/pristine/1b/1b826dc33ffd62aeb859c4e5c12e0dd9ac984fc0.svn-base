<?php
require './vendor/autoload.php';
use QL\QueryList;
class TaoBaoheaderAction extends BaseAction{
	public function articleget(){
		$this->headertype = M("headertype")->select();
		$this->display();
	}
	
	public function headertype(){
		if ($_GET['name']) {
			$and .= " and typename = '".$_GET['name']."'";
		}
		$this->list = M("headertype")->where("id is not null ".$and)->select();
		$this->display();
	}
	
	public function editpartment(){
		if ($_POST['id']) {
			$data['id'] = $_POST['id'];
			$data['typename'] = $_POST['typename'];
			$data['columnid'] = $_POST['columnid'];
			$data['createtime'] = date("Y-m-d");
			$is = M("headertype")->save($data);
			if ($is) {
				$data2['msg'] = 1;
			} else {
				$data2['msg'] = 2;
			}
		} else {
			$data['columnid'] = $_POST['columnid'];
			$data['typename'] = $_POST['typename'];
			$data['createtime'] = date("Y-m-d");
			$is = M("headertype")->add($data);
			if ($is) {
				$data2['msg'] = 1;
			} else {
				$data2['msg'] = 2;
			}
		}
		echo json_encode($data2);
	}
	
	public function caijishow(){
		$type = $_GET['headertype'];
		$number = $_GET['number'];
		$_SESSION['page'] = 0;
		$url = C("caijiurl")."?columnId=".$type."&publishId=0";
		$ch = curl_init();
		curl_setopt_array(
			$ch,
			array(
				CURLOPT_URL => $url,
				CURLOPT_REFERER => $url,
				CURLOPT_AUTOREFERER => true,
				CURLOPT_RETURNTRANSFER => true,
				CURLOPT_SSL_VERIFYPEER => false,
				CURLOPT_SSL_VERIFYHOST => false,
				CURLOPT_CONNECTTIMEOUT => 1,
				CURLOPT_TIMEOUT => 30,
				CURLOPT_USERAGENT => 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36'
			)
		);
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER,true);
        $result = curl_exec($ch);
        if(curl_errno($ch)){
            print_r(curl_error($ch));
        }
        curl_close($ch);
        $_SESSION['count'] = 0;
		$result = iconv("GBK","UTF-8",$result);
		$result = trim($result);
		$this->number = $number;
		$this->type = $type;
		$this->content = $result;
		$this->display();
	}
	
	public function caijiinfo(){
		$url = $_GET['detailUrl'];
		$id = $_GET['publishId'];
		$number = $_GET['number'];
		$name = $_GET['names'];
		$pic = $_GET['piclist'];
		$urllist = split(",",$url);
		$name = split("&",$name);
		$pic = split("&",$pic);
		$type = $_GET['type'];
		$page = $_GET['page'];
		$rules = array(
				"title"  =>array("div .detail-title","html"),
				"time"   =>array("div .detail-time","html"),
				"content"=>array("div .detail","html")
		
		);
		$craetetime = date("Y-m-d H:i:s");
		$sql = "insert into wt_caiji(content,title,time,createtime,picimage,typeid) values";
		if ($page < $number) {
			for ($i = 0;$i < count($urllist);$i++) {
				$html = "https://headline.taobao.com/feed/feedDetail.htm?id=".$urllist[$i];
				$message['data'][$i]['name'] = $name[$i];
				$data = QueryList::Query($html,$rules,'','UTF-8','GB2312',true)->data;
				//查询是否有重复
				$list = M("caiji")->where("title = '".$data[0]['title']."'")->select();
				$me .= M("caiji")->getLastSql()."||";
				$content = $data[0]['content'];
				$title = $data[0]['title'];
				$time = $data[0]['time'];
				$picimage = $pic[$i];
				if (!$list) {
					$sql .= "('".$content."','".$title."','".$time."','".$craetetime."','".$picimage."',".$type."),";
					$_SESSION['count']++;
				}
			}
			$sql = substr($sql,0,-1);
			$message['count'] = $_SESSION['count'];
			file_put_contents("./sql.txt",count($urllist));
			M("caiji")->query($sql);
			//采集下一页内容
			if ($page < $number) {
				$url = C("caijiurl")."?columnId=".$type."&publishId=".$id;
				$ch = curl_init();
				curl_setopt_array(
				$ch,
				array(
				CURLOPT_URL => $url,
				CURLOPT_REFERER => $url,
				CURLOPT_AUTOREFERER => true,
				CURLOPT_RETURNTRANSFER => true,
				CURLOPT_SSL_VERIFYPEER => false,
				CURLOPT_SSL_VERIFYHOST => false,
				CURLOPT_CONNECTTIMEOUT => 1,
				CURLOPT_TIMEOUT => 30,
				CURLOPT_USERAGENT => 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36'
						)
				);
				curl_setopt($ch, CURLOPT_URL, $url);
				curl_setopt($ch, CURLOPT_RETURNTRANSFER,true);
				$result = curl_exec($ch);
				if(curl_errno($ch)){
					print_r(curl_error($ch));
				}
				curl_close($ch);
				$content = "";
				$result = iconv("GBK","UTF-8",$result);
				$result = trim($result);
				$message['result'] = $result;
			}
		}
		echo json_encode($message);
	}
	
	public function articlemanager(){
		$and = "";
		if ($_GET['id']) {
			$and .= " and a.id = ".$_GET['id'];
		}
		if ($_GET['starttime']) {
			$and .= " and a.createtime >= '".$_GET['starttime']." 00:00:00'";
		}
		if ($_GET['endtime']) {
			$and .= " and a.createtime <= '".$_GET['endtime']." 23:59:59'";
		}
		if ($_GET['headertype']) {
			$and .= " and b.id = ".$_GET['headertype'];
		}
		import("ORG.Util.Page");
		$totalRows = M()->table("wt_caiji a,wt_headertype b")->where("a.typeid = b.columnid ".$and)->count();
		$page = new Page($totalRows,30);
		$this->list = M()->table("wt_caiji a,wt_headertype b")->where("a.typeid = b.columnid ".$and)->limit($page->firstRow,$page->listRows)->field("a.*,b.typename")->order("a.id desc")->select();
// 		echo M()->getLastSql();
		$this->page = $page->show();
		$this->headertype = M("headertype")->select();
		$this->display();
	}
	
	public function delcaiji(){
		$id = $_GET['id'];
		$is = M("caiji")->where("id = ".$id)->delete();
		if ($is) {
			$data['msg'] = 1;
		} else {
			$data['msg'] = 0;
		}
		echo json_encode($data);
	}
	
	public function editconten(){
		if ($_GET['id']) {
			$this->classlist = M('caiji')->find($_GET['id']);
		}
		$this->headertype = M("headertype")->select();
		$this->display();
	}
	
	public function editcaiji(){
		import('ORG.Net.UploadFile');
		$upload = new UploadFile();
		$upload->maxSize  = 3145728 ;
		$upload->allowExts  = array('jpg', 'png', 'jpeg');
		$upload->savePath =  './picimage/';
		$upload->upload();
		$info = $upload->getUploadFileInfo();
		if ($info[0]['savename']) {
			$data['picimage'] = './picimage/'.$info[0]['savename'];
		}
		$data['title'] = $_POST['title'];
		$data['typeid'] = $_POST['typeid'];
		$data['time'] = $_POST['time'];
		$data['content'] = $_POST['editor'];
		$data['id'] = $_POST['id'];
		M("caiji")->save($data);
		$this->redirect("TaoBaoheader/articlemanager");
	}
}
?>